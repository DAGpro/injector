language: php

env:
  global:
    - DEFAULT_COMPOSER_FLAGS="--prefer-dist --no-interaction --no-progress --optimize-autoloader"
    - TASK_STATIC_ANALYSIS=0
    - TASK_TESTS_COVERAGE=0

matrix:
  include:
    - php: "7.4"
      env:
        - TASK_STATIC_ANALYSIS=0 # set to 1 to enable static analysis
        - TASK_TESTS_COVERAGE=1

# faster builds on new travis setup not using sudo
sudo: false

# cache vendor dirs
cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || echo "xdebug is not installed"

install:
  - travis_retry composer self-update && composer --version
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - travis_retry composer install $DEFAULT_COMPOSER_FLAGS
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      pecl install ast
    fi

before_script:
  - php --version
  - composer --version
  # enable code coverage
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
        PHPUNIT_COVERAGE_FLAG="--coverage-clover=coverage.clover"
    fi

script:
  - phpdbg -qrr vendor/bin/phpunit --verbose $PHPUNIT_COVERAGE_FLAG
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      composer phan
    fi
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      cat analysis.txt
    fi

after_script:
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
      travis_retry wget https://scrutinizer-ci.com/ocular.phar
      php ocular.phar code-coverage:upload --format=php-clover coverage.clover
    fi


notifications:
  slack:
    -
      rooms:
        -
          secure: ISnJT0I2lKKbrAybXaIqzLWHrVeWdUvPkIPm4DGq1FGhYm1UcXArtKVxtvbg00+3rj/5DfXTTtWQGj0pFY5Icp22GIR+pFl50fIDHZlav0SSQWf9Xl8oHhTKZNEnMbBQ4iJe5RmmsCm+4lSraDGVG7SwjgdpTGnlTQFyPJt5zAFRGmJEXEaN81Ah9L9KtYAXS69Bg1CgQNBQHqUJ0OIM0rQhZj1U6N3FFbvKyxs8AGBTsPT7Um3t+nhTnkHqu5nGoIxJlj/x2FCmsZXIF8jUhu7rE6dDjvRNaeX8af2InMGnC+DECIRy5aWQx66jgRKLGT4ZieIWcpdahTJIi9Tf/wdDlJj515SVRKzaOQOCypSnqZcnoTAuGFmwO5qPlDiC0WEvUvHJ94Tmp6ScMRZX1KcdjR2qpz1DuBDY9XHMvey4PW8oEzjfRzazNKmn5HVHiTzkPrgI1wWfDMVwNEHdeLrXUeIHP5kpP6R40z7WMPi40on/N8skdLEIYf8CLrcZnWhZnXW58APOfWt+1ec2ma/ixO1wlxIqdIgvGtgw+Z+hzbh9r1hWOK2GNiw9AkSfcKMG0CYAI9Xzej9pFEfEHwj+4kdE2VwVafm1hJcTips1azQgVaS2Wt+RkXUXmvNtDt7ETfPzT+biq7+nu5dCNJPxIv74VYRNrsHefrBgqXQ=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: hXCQeNdG9+LRQCPIy0sqdy+yIDU7Bcn0oxm4dFEwwZ5Vek6utTWbPy8xBR/ujv8zX0a9vTGuNzRnO4uDh4o4JV4peEGpojFW+NVuu93CnzvvhCwECc2MEC1dsctaLeLN9sxsnpRgUvcUyl4vkGnA0ZOCzcVRqk7uGak9BbC2aRislsbWsMhxQwnICyrK+vNWwRDs7co0aTyNTAkJU6ddsxpd6cpXKC3iy8ytWSZH1XiJnas7NvKQPbwB55dP2SE9bQz5yNLZHuhdCga5OTuba/z3E2cHZsdxwHazuABVvJAPPZnuTW1uuzrzfXi4pWAs1wZoMkW22UBTz7Tf+3PW88k4zz4wFPXbH/ew3Liui3VdB/ZxnPZMXVG9Fsuqf4UO58Sh9F6EVlXIChrlq5L6Zda3wwPy4Dn141QRo2oVrnPa9MCrHKsSYcO/uKAP0wF+K+sh/w6Nr/UrDa5W2X2Ihv+GseyO/v2Uo//ZPwqeKsSw+AW5QTxI/XwuXLfVxQlDKa1jX4B9mRLffga5EZ++M5besz+pxTSHLjxEorVOenY2mccm5RCeBicnT0niuC2vTihcsVa75R9cLock0N2ONmuAD4U0+De8ODmbWZTs97FlHvBD28VCxrf+yzNeuHJPgwoEX2985poJjHIP9BH/G3g+px5MGmFU9atxtnHrfIc=
      on_success: never
      on_failure: always
      on_pull_requests: false
